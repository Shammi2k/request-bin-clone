<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RequestBin - API Request Logger</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0F172A;
      color: #F8FAFC;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 48px;
      margin-bottom: 10px;
      background: linear-gradient(to right, #06B6D4, #8B5CF6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: #94A3B8;
      font-size: 18px;
    }

    .card {
      background: #1E293B;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid #334155;
    }

    .btn {
      background: #06B6D4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #0891B2;
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-danger {
      background: #EF4444;
    }

    .btn-danger:hover {
      background: #DC2626;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      background: #0F172A;
      border: 1px solid #334155;
      border-radius: 8px;
      color: #F8FAFC;
      font-size: 14px;
      margin-bottom: 15px;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #06B6D4;
    }

    .bin-url {
      background: #0F172A;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #8B5CF6;
      margin: 20px 0;
      word-break: break-all;
    }

    .bin-url a {
      color: #06B6D4;
      text-decoration: none;
    }

    .request-item {
      background: #0F172A;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #06B6D4;
    }

    .request-method {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
      margin-right: 10px;
    }

    .method-GET {
      background: #10B981;
    }

    .method-POST {
      background: #06B6D4;
    }

    .method-PUT {
      background: #F59E0B;
    }

    .method-DELETE {
      background: #EF4444;
    }

    .timestamp {
      color: #94A3B8;
      font-size: 12px;
    }

    pre {
      background: #0F172A;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 12px;
      margin-top: 10px;
    }

    .hidden {
      display: none;
    }

    .copy-btn {
      background: #8B5CF6;
      padding: 8px 16px;
      margin-left: 10px;
    }

    .copy-btn:hover {
      background: #7C3AED;
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>üóÑÔ∏è RequestBin</h1>
    <p class="subtitle">Capture and inspect HTTP requests in real-time</p>
  </header>

  <!-- Create Bin Section -->
  <div class="card">
    <h2>Create New Bin</h2>
    <p style="color: #94A3B8; margin-bottom: 20px;">
      Generate a unique URL to capture HTTP requests
    </p>

    <label>Expiry Hours (1-168):</label>
    <input type="number" id="expiryHours" value="24" min="1" max="168">

    <label>Max Requests (10-10000):</label>
    <input type="number" id="maxRequests" value="1000" min="10" max="10000">

    <button class="btn" onclick="createBin()">Create Bin</button>

    <div id="binResult" class="hidden">
      <h3 style="margin-top: 30px;">Your Bin URL:</h3>
      <div class="bin-url">
        <strong>URL:</strong> <a id="binUrl" href="#" target="_blank"></a>
        <button class="btn copy-btn" onclick="copyBinUrl()">Copy</button>
      </div>
      <p style="color: #94A3B8;">
        Send any HTTP request to this URL. All requests will be captured and logged below.
      </p>
      <button class="btn" onclick="loadBinDetails()" style="margin-right: 10px;">Refresh Requests</button>
      <button class="btn btn-danger" onclick="deleteBin()">Delete Bin</button>
    </div>
  </div>

  <!-- Captured Requests Section -->
  <div id="requestsSection" class="card hidden">
    <h2>Captured Requests <span id="requestCount" style="color: #06B6D4;"></span></h2>
    <div id="requestsList"></div>
  </div>
</div>

<script>
  let currentBin = null;

  async function createBin() {
    const expiryHours = document.getElementById('expiryHours').value;
    const maxRequests = document.getElementById('maxRequests').value;

    try {
      const response = await fetch('/api/bins', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ expiryHours: parseInt(expiryHours), maxRequests: parseInt(maxRequests) })
      });

      const result = await response.json();

      if (response.ok) {
        currentBin = result.data;
        document.getElementById('binUrl').textContent = currentBin.fullUrl;
        document.getElementById('binUrl').href = currentBin.fullUrl;
        document.getElementById('binResult').classList.remove('hidden');

        // Start auto-refresh
        startAutoRefresh();
      } else {
        alert('Error creating bin: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  async function loadBinDetails() {
    if (!currentBin) return;

    try {
      const response = await fetch(`/api/bins/${currentBin.uniqueUrl}/details`);
      const result = await response.json();

      if (response.ok) {
        displayRequests(result.data);
      } else {
        alert('Error loading requests: ' + result.message);
      }
    } catch (error) {
      console.error('Error loading requests:', error);
    }
  }

  function displayRequests(binData) {
    const requestsList = document.getElementById('requestsList');
    const requestsSection = document.getElementById('requestsSection');
    const requestCount = document.getElementById('requestCount');

    if (binData.requests.length === 0) {
      requestsList.innerHTML = '<p style="color: #94A3B8;">No requests captured yet. Send a request to your bin URL.</p>';
      requestsSection.classList.remove('hidden');
      return;
    }

    requestCount.textContent = `(${binData.currentRequestCount})`;
    requestsSection.classList.remove('hidden');

    requestsList.innerHTML = binData.requests.map(req => `
                <div class="request-item">
                    <div>
                        <span class="request-method method-${req.method}">${req.method}</span>
                        <span class="timestamp">${new Date(req.timestamp).toLocaleString()}</span>
                        <span style="color: #94A3B8; margin-left: 15px;">IP: ${req.ipAddress}</span>
                    </div>

                    ${Object.keys(req.queryParams).length > 0 ? `
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #06B6D4;">Query Params</summary>
                            <pre>${JSON.stringify(req.queryParams, null, 2)}</pre>
                        </details>
                    ` : ''}

                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: #06B6D4;">Headers</summary>
                        <pre>${JSON.stringify(req.headers, null, 2)}</pre>
                    </details>

                    ${req.body ? `
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; color: #06B6D4;">Body</summary>
                            <pre>${req.body}</pre>
                        </details>
                    ` : ''}
                </div>
            `).join('');
  }

  async function deleteBin() {
    if (!currentBin) return;

    if (!confirm('Are you sure you want to delete this bin?')) return;

    try {
      const response = await fetch(`/api/bins/${currentBin.uniqueUrl}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        alert('Bin deleted successfully');
        location.reload();
      } else {
        alert('Error deleting bin');
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  function copyBinUrl() {
    const url = document.getElementById('binUrl').textContent;
    navigator.clipboard.writeText(url);
    alert('Bin URL copied to clipboard!');
  }

  let autoRefreshInterval;

  function startAutoRefresh() {
    // Refresh every 3 seconds
    autoRefreshInterval = setInterval(() => {
      loadBinDetails();
    }, 3000);
  }

  // Stop auto-refresh when page is hidden
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      clearInterval(autoRefreshInterval);
    } else if (currentBin) {
      startAutoRefresh();
    }
  });
</script>
</body>
</html>